var nr=(h,c,n)=>{if(!c.has(h))throw TypeError("Cannot "+n)};var m=(h,c,n)=>(nr(h,c,"read from private field"),n?n.call(h):c.get(h)),ht=(h,c,n)=>{if(c.has(h))throw TypeError("Cannot add the same private member more than once");c instanceof WeakSet?c.add(h):c.set(h,n)};(function(h,c){typeof exports=="object"&&typeof module<"u"?c(exports):typeof define=="function"&&define.amd?define(["exports"],c):(h=typeof globalThis<"u"?globalThis:h||self,c(h["lw-math"]={}))})(this,function(h){var d;"use strict";var c=(t=>(t.Term="t",t.Factor="f",t))(c||{}),n=(t=>(t.Add="+",t.Sub="-",t.Div="/",t.Mul="*",t))(n||{}),w=(t=>(t.Root="~",t.Function="f()",t.Brackets="()",t.Number="n",t.Constant="c",t.PostfixOperator="po",t))(w||{});const o=t=>t.type==="t",N=t=>t.type==="f",M=t=>r=>N(r)&&r.name===t,k=M("~"),C=M("()"),v=M("f()"),O=M("c"),E=M("n"),B=M("po"),S=t=>k(t)||C(t)||v(t),_=t=>v(t)||C(t),J=t=>Object.keys(t),K=()=>({type:c.Factor,name:w.Root,$$expressions:[]}),Q=()=>({type:c.Factor,name:w.Brackets}),tt=(t,r,e)=>({type:c.Factor,name:w.Function,value:t,left:e==null?void 0:e.arg,right:e==null?void 0:e.body,isClosed:r&&!!(e!=null&&e.arg)&&!!(e!=null&&e.body),isArgRequired:r}),rt=t=>({type:c.Factor,name:w.Constant,value:t}),U=(t,r=!1)=>({type:c.Factor,name:w.Number,value:t,isConst:r}),L=(t,r)=>({type:c.Factor,name:w.PostfixOperator,value:t,left:void 0,right:r}),b=t=>({type:c.Term,name:t}),j={0:/^[()]$/,1:/^(\w+)\(([\w.]+)?(,?)\s?([\w.]+)?\)?$/,2:/^[.\dE]+$/,3:/^[a-zA-Z]+$/,4:/^[!%]$/,5:/^[-/+*]$/},ft=(t,r=J(j))=>{let e=null,i;for(let s of r)if(e=j[s].exec(t),e){i=s;break}return[i,e]},gt=(t,r)=>{if(t==="2")return U(r[0],r[0].length>1);if(t==="3")return rt(r[0]);if(t==="5")return b(r[0]);if(t==="4")return L(r[0]);if(t==="0"&&r[0]==="(")return Q();if(t==="1"){const[,e,i,s,u]=r;let g=i?q(i,["2","3"]):void 0,T=u?q(u,["2","3"]):void 0;return tt(e,!!s,{arg:s?g:void 0,body:s?T:g})}throw new Error('Unexpected value."')},q=(t,r=J(j))=>{const[e,i]=ft(t,r);if(!e||!i)throw new Error(`Unexpected string ${t}`);return gt(e,i)},z={[n.Add]:1,[n.Sub]:1,[n.Div]:2,[n.Mul]:2},D=t=>o(t)?z[t.name]:3,F=(t,r)=>t.right&&!S(t.right)&&!B(t.right)?F(t.right,t):[t,r],et=(t,r,e)=>t.right&&o(t.right)&&z[t.right.name]===r?[t.right,t]:t.right&&o(t.right)?et(t.right,r,t):[t,e],pt=(t,r)=>r.name!==n.Sub||r.name===n.Sub&&t.name===n.Add,dt=t=>o(t)&&(!t.left&&!t.right||!!t.right&&o(t.right)&&!t.right.left),P=(t,r)=>{const e=D(r),[i,s]=et(t,e);if(!dt(i)){if(o(i)&&i.left&&!i.right&&s){if(i.name===r.name)return;if(pt(i,r))return r.left=i.left,i.left=void 0,s.right=r,r}if(!(!(s??i).right&&r.name!==n.Sub))return e>1&&D(i)<2||o(i)&&!i.right?(r.left=i.right,i.right=r):(r.left=(s??i).right,(s??i).right=r),r}},it=t=>t.value.includes("E"),vt=t=>t.value.includes("."),mt=t=>!t.value.endsWith("."),yt=(t,r)=>{if(!(r.value==="E"&&(!mt(t)||it(t)))&&!(r.value==="."&&(vt(t)||it(t)))){if(t.value==="0"&&r.value!=="E"&&r.value!=="."){t.value=r.value;return}t.value+=r.value}},Ft=(t,r)=>{let[e]=F(t);if(E(e)&&!(r.isConst||e.isConst)){yt(e,r);return}N(e)&&(!S(e)||e.right)&&(e=P(t,b(n.Mul))??e),e.right=r},xt=(t,r)=>{let[e]=F(t);N(e)&&(!S(e)||e.right)&&(e=P(t,b(n.Mul))??e),e.right=r},$t=(t,r)=>{let[e,i]=F(t);k(e)&&!e.right||o(e)&&!e.right||(o(e)?(r.right=e.right,e.right=r):(r.right=(i??e).right,(i??e).right=r))},st=(t,r)=>{let[e]=F(t);return N(e)&&(e=P(t,b(n.Mul))??e),e.right=r,r},wt=(t,r)=>{let[e,i]=F(t);if(e.right&&_(e.right)&&e.right.isClosed&&!r.left)i=e,e=e.right;else if(o(e)&&!e.right&&!r.left)return;if(!k(e)&&i&&!r.left)return r.left=i.right,i.right=r,r.left&&r.right&&(r.isClosed=!0),r;if(r.left)return N(e)&&!S(e)&&(e=P(t,b(n.Mul))??e),e.right=r,r},G=t=>{const[r,e]=F(t);if(r.right&&B(r.right)){r.right=r.right.right;return}if(r.right&&v(r.right)&&r.right.isArgRequired){if(!r.right.right){r.right=r.right.left;return}G(r.right);return}if(r.right&&_(r.right)){if(r.right.isClosed){r.right.isClosed=!1;return}if(!r.right.right){r.right=void 0;return}G(r.right);return}if(E(r)){(r.isConst||r.value.length===1)&&e?e.right=void 0:r.value=r.value.slice(0,-1);return}if(O(r)&&e){e.right=void 0;return}if(o(r)&&e){e.right=r.left;return}},nt=(t,r)=>{t.right=typeof r=="string"?q(r):typeof r=="number"?U(String(r),String(r).length>1):void 0,t.right&&S(t.right)&&t.$$expressions.splice(0,t.$$expressions.length,t.right)},Et=(t,r)=>{t.$$expressions[0]&&!t.$$expressions[0].right&&t.$$expressions.shift(),t.$$expressions[0]&&v(t.$$expressions[0])&&t.$$expressions[0].isClosed&&(t.$$expressions[0].isClosed=!1),G(t),t.right||nt(t,r)},W=t=>t.$$expressions.find(r=>_(r)&&!r.isClosed)??t,V=(t,r)=>{const e=W(t),s=v(e)&&e.isArgRequired&&e.right&&(!o(e.right)||o(e.right)&&!!e.right.right),u=r&&e.right&&E(r)&&!r.isConst&&E(e.right)&&!e.right.isConst;s&&!u&&!(r&&v(r)&&r.isArgRequired)&&(e.isClosed=!0,V(t,r))},bt=t=>{let r=W(t);const[e]=F(r);v(r)&&r.isArgRequired&&(V(t),r=W(t)),_(r)&&r.right&&(!o(e)||o(e)&&e.right)&&(r.isClosed=!0)},At=(t,r)=>{V(t,r);const e=W(t);let i;o(r)?P(e,r):E(r)?Ft(e,r):O(r)?xt(e,r):B(r)?$t(e,r):C(r)?i=st(e,r):v(r)&&(r.isArgRequired?i=wt(e,r):i=st(e,r)),i&&t.$$expressions.unshift(i)},Mt=(t,r)=>{var g;const e=t.left?x(t.left,r):"",i=t.right?x(t.right,r):"",s=((g=r.operators)==null?void 0:g[t.name])||t.name,u=t.left&&o(t.left)&&D(t.left)>1&&D(t)<2;return`${e}${e?" ":""}${s}${e&&!u&&i?" ":""}${i}`},kt=(t,r)=>{const e=t.right?x(t.right,r):"";return(r.renderBrackets??ut.renderBrackets)({body:e,isClosed:!!t.isClosed})},Nt=(t,r)=>{var s,u;const e=t.left?x(t.left,r):"",i=t.right?x(t.right,r):"";return(((s=r.renderFunction)==null?void 0:s[t.value])??((u=r.renderFunction)==null?void 0:u.default)??ut.renderFunction.default)({left:e,right:i,name:t.value,isClosed:!!t.isClosed})},ut={renderBrackets:({body:t,isClosed:r})=>`(${t}${r?")":""}`,renderFunction:{default:({name:t,left:r,right:e,isClosed:i})=>`${t}(${r?`${r}, `:""}${e}${i?")":""}`},constants:{},operators:{}},x=(t,r={})=>{var e;return k(t)&&t.right?x(t.right,r):o(t)?Mt(t,r):C(t)?kt(t,r):v(t)?Nt(t,r):E(t)?t.value:O(t)?((e=r.constants)==null?void 0:e[t.value])??t.value:B(t)?`${t.right?x(t.right,r):""}${t.value}`:""},X=t=>t*Math.PI/180,Y=t=>t*180/Math.PI,Ct=(t,r)=>t+r,Bt=(t,r)=>t-r,St=(t,r)=>t/r,Pt=(t,r)=>t*r,Tt=Math.pow,Rt=(t,r)=>Math.abs(t)**(1/r)*(t<0?-1:1),It=(t,r)=>$(Math.sin(r==="deg"?X(t):t),11),Ot=(t,r)=>$(Math.cos(r==="deg"?X(t):t),11),_t=(t,r)=>{const e=Math.tan(r==="deg"?X(t):t);return e>Number.MAX_SAFE_INTEGER?Number.POSITIVE_INFINITY:e},Ut=(t,r)=>{if(t>1||t<-1)throw new Error("Argument of arcsin expected value in range = -1 <= a <= 1");const e=Math.asin(t);return r==="deg"?Y(e):e},qt=(t,r)=>{if(t>1||t<-1)throw new Error("Argument of acos expected value in range = -1 <= a <= 1");const e=Math.acos(t);return r==="deg"?Y(e):e},Dt=(t,r)=>{const e=Math.atan(t);return r==="deg"?Y(e):e},Wt=t=>Math.sqrt(t),Lt=t=>Math.log(t),jt=t=>Math.log10(t),$=(t,r=0)=>Number.parseFloat(t.toFixed(r)),at=t=>{let r=t;const e=7,i=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,15056327351493116e-23];if(r<.5)return Math.PI/Math.sin(r*Math.PI)/at(1-r);r--;let s=i[0];for(let g=1;g<e+2;g++)s+=i[g]/(r+g);const u=r+e+.5;return Math.sqrt(2*Math.PI)*u**(r+.5)*Math.exp(-u)*s},zt=t=>{if(t%1!==0)return at(t+1);if(t===0)return 1;let e=t;for(let i=Math.abs(t);--i;)e*=i;return e},Gt=t=>{let[r,e]=t.value.split("E");return r==="."&&(r=`${r}0`),parseFloat(r||"1")*(e?10**Number(e):1)},Z={isDegree:!1,defineFunctions:{sin:(t,r,{options:e})=>$(It(r,e.isDegree?"deg":"rad"),11),cos:(t,r,{options:e})=>$(Ot(r,e.isDegree?"deg":"rad"),11),tan:(t,r,{options:e})=>$(_t(r,e.isDegree?"deg":"rad"),11),arcsin:(t,r,{options:e})=>$(Ut(r,e.isDegree?"deg":"rad"),11),arccos:(t,r,{options:e})=>$(qt(r,e.isDegree?"deg":"rad"),11),arctan:(t,r,{options:e})=>$(Dt(r,e.isDegree?"deg":"rad"),11),ln:(t,r)=>Lt(r),log:(t,r)=>jt(r),sqrt:(t,r)=>Wt(r),pow:(t,r)=>{if(typeof t!="number")throw new Error("unknown argument");return Tt(t,r)},root:(t,r)=>{if(typeof t!="number")throw new Error("Unknown argument");return Rt(t,r)}},postfixOperators:{"!":(t,r)=>zt(r),"%":(t,r,{parent:e,options:i})=>e&&o(e)&&e.left&&[n.Sub,n.Add].includes(e.name)?y(e.left,i)/100*r:r/100},defineConst:{Pi:Math.PI,e:Math.E}},Vt=(t,r)=>{if(!t.left&&t.name!==n.Sub||!t.right)throw new Error(`Operator "${t.name}" cannot be evaluated`);const e=t.left?y(t.left,r,t):0,i=y(t.right,r,t);return{[n.Add]:Ct,[n.Sub]:Bt,[n.Mul]:Pt,[n.Div]:St}[t.name](e,i)},Xt=(t,r,e)=>{var g;if(!t.right||t.isArgRequired&&!t.left)throw new Error(`Function ${t.value} missed an argument.`);const i=((g=r.defineFunctions)==null?void 0:g[t.value])??Z.defineFunctions[t.value];if(!i)throw new Error(`Unknown function "${t.value}"`);const s=t.left&&y(t.left,r,t),u=t.right&&y(t.right,r,t);return i(s,u,{node:t,parent:e,options:r})},Yt=(t,r,e)=>{var u;const i=((u=r.postfixOperators)==null?void 0:u[t.value])??Z.postfixOperators[t.value];if(!i||!t.right)throw new Error(`Unknown operator "${t.value}" or operand is undefined.`);const s=y(t.right,r,t);return i(void 0,s,{node:t,parent:e,options:r})},y=(t,r={},e)=>{var i;if(o(t))return Vt(t,r);if(E(t))return Gt(t);if(O(t))return((i=r.defineConst)==null?void 0:i[t.value])??Z.defineConst[t.value];if(v(t))return Xt(t,r,e);if(B(t))return Yt(t,r,e);if(C(t)){if(!t.right)throw new Error("Empty bracket.");return y(t.right,r,t)}return k(t)?t.right?y(t.right,r,t):0:Number.NaN};class ct{constructor(r){ht(this,d,K());this.defaultValue=r,this.setValue(r)}get root(){return m(this,d)}setValue(r){r&&typeof r=="object"&&k(r)?(m(this,d).right=r.right,m(this,d).$$expressions=r.$$expressions):nt(m(this,d),r)}push(r){if(typeof r=="number"){this.pushNode(U(String(r),String(r).length>1));return}if(r===")"){this.closeBracket();return}this.pushNode(typeof r=="string"?q(r):r)}pushNode(r){At(m(this,d),r)}pop(){Et(m(this,d),this.defaultValue)}closeBracket(){bt(m(this,d))}render(r){return x(m(this,d),r)}evaluate(r){return y(m(this,d),r)}}d=new WeakMap;const Zt=t=>new ct(t),Ht=/^[\d.E]+/,Jt=/^\w+/,Kt=/^\w+\(/,Qt=/^[-/*+]/,tr=/^!/,rr=/^\s*/,ot=[[0,Ht],[6,/^,/],[5,/^\(|^\)/],[2,Kt],[1,Jt],[4,tr],[3,Qt]],er=function*(t){var i,s,u;let r=0,e=!1;for(;r<t.length;){r+=((i=t.slice(r).match(rr))==null?void 0:i[0].length)??0;const g=t.slice(r);for(let[T,a]of ot){const f=(s=g.match(a))==null?void 0:s[0];if(f){e&&(r-=f.length),e=yield{type:T,value:f},r+=f.length;break}if(T===((u=ot.at(-1))==null?void 0:u[0]))throw new Error("Unexpected token")}}},ir=t=>{const r=er(t),e=[],i=()=>{var f,R,I,A;const a=r.next().value;if(!a)throw new Error("Invalid input");if(a.type===0)return U(a.value);if(a.type===1)return rt(a.value);if(a.value==="("){const l=Q();e.unshift(l);const p=u(0);if(((f=r.next())==null?void 0:f.value.value)!==")"||Array.isArray(p))throw new Error('Expected ")"');return l.right=p,l.isClosed=!0,l}if(a.type===2){const l=tt(a.value.slice(0,-1));e.unshift(l);const p=u(0);if(((R=r.next())==null?void 0:R.value.value)!==")")throw new Error('Expected ")"');return Array.isArray(p)?(l.isArgRequired=!0,l.left=p[0],l.right=p[1]):(l.isArgRequired=!1,l.right=p),l.isClosed=!0,l}if(a.type===3){let l=i();for(;((A=(I=r.next(!0))==null?void 0:I.value)==null?void 0:A.type)===4;)l=L(r.next().value.value,l);const p=b(a.value);return p.right=l,p}throw new Error("unknown token")},s=a=>a.type===3?z[a.value]??3:a.type===6?.5:0,u=(a=0)=>{var R,I;let f=i();for(;((I=(R=r.next(!0))==null?void 0:R.value)==null?void 0:I.type)===4;)f=L(r.next().value.value,f);for(;;){const A=r.next(!0).value;if(!A)return f;const l=s(A);if(l<=a)return f;if(A.type===6){r.next();const lt=u();if(Array.isArray(lt))throw new Error("Unexpected comma");return[f,lt]}r.next();const p=u(l);if(Array.isArray(p))throw new Error("Unexpected comma");const H=b(A.value);H.left=f,H.right=p,f=H}};return(a=>{const f=K();return f.right=a,f.$$expressions=e,f})((()=>{const a=u(0);if(Array.isArray(a))throw new Error("Unexpected comma");return a})())},sr={renderBrackets:({body:t})=>`(${t})`,renderFunction:{default:({name:t,left:r,right:e})=>`${t}(${r?`${r}, `:""}${e})`},constants:{},operators:{}};h.Expression=ct,h.createExpression=Zt,h.parseExpression=ir,h.renderOptionsForParser=sr,Object.defineProperty(h,Symbol.toStringTag,{value:"Module"})});
